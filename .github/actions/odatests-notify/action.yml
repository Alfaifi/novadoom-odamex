name: OdaTests Notifier

inputs:
  demos-run:
    description: "Number of demo tests that were run"
    required: true
  demos-passed:
    description: "The number of demo tests that passed"
    required: true
  discord-url:
    description: "Webhook url for discord"
    required: true

runs:
  using: "composite"
  steps:
    - name: "Get previous run ID"
      id: get-run
      uses: actions/github-script@v7
      with:
        script: |
          const runs = await github.rest.actions.listWorkflowRuns({
            owner: = context.repo.owner,
            repo: context.repo.repo,
            workflow_id: context.workflow,
            branch: context.ref.replace("/refs/heads/", ""),
            status: "success"
          });
          if (runs.data.workflow_runs.length > 1) {
            core.setOutput("run_id", runs.data.workflow_runs[1].id);
          }

    - name: Download previous run artifact
      uses: actions/download-artifact@v5
      with:
        name: test-data
        repository: ${{ github.repository }}
        run-id: ${{ steps.get-run.outputs.run_id }}
        path: ./test-data

    - name: Load previous run values
      id: previous
      shell: pwsh
      run: |
        $branchName = "${{ github.ref_name }}" -replace '/', '_'
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        git fetch origin odatests-results
        git checkout odatests-results

        $jsonPath = "$branchName.json"
        if (Test-Path $jsonPath) {
          $jsonContent = Get-Content $jsonPath -Raw | ConvertFrom-Json
          echo "previous-total=$($jsonContent.demos_run)" >> $env:GITHUB_OUTPUT
          echo "previous-passes=$($jsonContent.demos_passed)" >> $env:GITHUB_OUTPUT
        } else {
          echo "previous-total=0" >> $env:GITHUB_OUTPUT
          echo "previous-passes=0" >> $env:GITHUB_OUTPUT
        }

    - name: Notify discord if values changed
      if: steps.previous.outputs.previous-total != inputs.demos-run || steps.previous.outputs.previous-passes != inputs.demos-passed
      uses: tsickert/discord-webhook@7.0.0
      with:
        webhook-url: ${{ inputs.discord-url }}
        content: |
          ğŸ§ª **OdaTests Results Have Changed**

          **Previous:** `${{ steps.previous.outputs.previous-passes }}/${{ steps.previous.outputs.previous-total }}`
          **Current:** `${{ inputs.demos-passed }}/${{ inputs.demos-run }}`

          ğŸ”— [Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          ğŸ” [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

    - name: Write current run values
      shell: pwsh
      run: |
        $branchName = "${{ github.ref_name }}" -replace '/', '_'
        $jsonPath = "$branchName.json"
        $obj = @{
          demos_run = ${{ inputs.demos-run }}
          demos_passed = ${{ inputs.demos-passed }}
          updated_at = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
        }

        $jsonContent = $obj | ConvertTo-Json -Depth 3
        Set-Content -Path $jsonPath -Value $jsonContent -Encoding UTF8

        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"
        git fetch origin odatests-results
        git checkout odatests-results

        git add $jsonPath
        $commitMsg = "Update CI state for $branchName [ci skip]"
        git commit -m $commitMsg -a || Write-Host "No changes to commit"
        git push origin odatests-results