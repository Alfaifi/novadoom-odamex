name: Windows-Release-Candidate

on:
  push:
    branches:
    - 'release/[0-9]+.[0-9]+.[0-9]+' # Only run on major.minor.patch releases

permissions:
  contents: write

jobs:
  pre_job:
    name: Build Preparation
    runs-on: ubuntu-latest
    outputs:
      build_number: ${{ steps.revlist.outputs.totalCommits }}
      new_version: ${{ steps.gitversion.outputs.majorMinorPatch }}
      major: ${{ steps.gitversion.outputs.major }}
      minor: ${{ steps.gitversion.outputs.minor }}
      patch: ${{ steps.gitversion.outputs.patch }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # Required due to the way Git works, without it this action won't be able to find any or the correct tags
      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v4.1.0
        with:
          versionSpec: '6.x'
      - name: Determine Version
        id:   gitversion
        uses: gittools/actions/gitversion/execute@v4.1.0
      - name: Get Commits From Source
        id:   revlist
        shell: pwsh
        run: |
          $commits = git rev-list HEAD --count
          Write-Output "totalCommits=$commits" >> $env:GITHUB_OUTPUT
      - name: Display GitVersion outputs
        run: |
          echo "Major: ${{ steps.gitversion.outputs.major }}"
          echo "Minor: ${{ steps.gitversion.outputs.minor }}"
          echo "Patch: ${{ steps.gitversion.outputs.patch }}"
          echo "PreReleaseTag: ${{ steps.gitversion.outputs.preReleaseTag }}"
          echo "PreReleaseTagWithDash: ${{ steps.gitversion.outputs.preReleaseTagWithDash }}"
          echo "PreReleaseLabel: ${{ steps.gitversion.outputs.preReleaseLabel }}"
          echo "PreReleaseNumber: ${{ steps.gitversion.outputs.preReleaseNumber }}"
          echo "WeightedPreReleaseNumber: ${{ steps.gitversion.outputs.weightedPreReleaseNumber }}"
          echo "BuildMetaData: ${{ steps.gitversion.outputs.buildMetaData }}"
          echo "FullBuildMetaData: ${{ steps.gitversion.outputs.fullBuildMetaData }}"
          echo "MajorMinorPatch: ${{ steps.gitversion.outputs.majorMinorPatch }}"
          echo "SemVer: ${{ steps.gitversion.outputs.semVer }}"
          echo "AssemblySemVer: ${{ steps.gitversion.outputs.assemblySemVer }}"
          echo "AssemblySemFileVer: ${{ steps.gitversion.outputs.assemblySemFileVer }}"
          echo "FullSemVer: ${{ steps.gitversion.outputs.fullSemVer }}"
          echo "InformationalVersion: ${{ steps.gitversion.outputs.informationalVersion }}"
          echo "BranchName: ${{ steps.gitversion.outputs.branchName }}"
          echo "EscapedBranchName: ${{ steps.gitversion.outputs.escapedBranchName }}"
          echo "Sha: ${{ steps.gitversion.outputs.sha }}"
          echo "ShortSha: ${{ steps.gitversion.outputs.shortSha }}"
          echo "VersionSourceSha: ${{ steps.gitversion.outputs.versionSourceSha }}"
          echo "CommitsSinceVersionSource: ${{ steps.gitversion.outputs.commitsSinceVersionSource }}"
          echo "UncommittedChanges: ${{ steps.gitversion.outputs.uncommittedChanges }}"
          echo "CommitDate: ${{ steps.gitversion.outputs.commitDate }}"
          echo "TotalCommits: ${{ steps.revlist.outputs.totalCommits }}"
  build:
    name: Build (Visual Studio)
    needs: pre_job
    runs-on: windows-latest
    env:
      build_number: ${{ needs.pre_job.outputs.build_number }}
      new_version: ${{ needs.pre_job.outputs.new_version }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Required due to the way Git works, without it this action won't be able to find any or the correct tags
    - name: Run Upversion
      id:   upversion
      shell: pwsh
      run: |
        .\tools\upversion\upversion.ps1
      env:
        MAJORVERSION: ${{ needs.pre_job.outputs.major }}
        MINORVERSION: ${{ needs.pre_job.outputs.minor }}
        PATCHVERSION: ${{ needs.pre_job.outputs.patch }}
    - name: Checkout submodules
      run: git submodule update --init --recursive
    - name: Turn on problem matcher
      uses: ammaraskar/msvc-problem-matcher@master
    - name: Run build powershell
      shell: pwsh
      run: |
        .\ci\win-release-x64.ps1
    - name: Install Python packages
      uses: insightsengineering/pip-action@v2
      with:
        packages: |
          b2sdk
    - name: Upload artifact to B2
      run: python .\ci\upload-b2.py .\Output\zip Win-x64
      env:
        B2_APP_KEY: ${{ secrets.B2_APP_KEY }}
        B2_BUCKET_ID: ${{ secrets.B2_BUCKET_ID }}
        B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
    - name: Archive x64 build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Odamex-Win-x64
        path: Output/zip/*.zip
    - name: Archive x64 pdb artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Odamex-Win-x64-pdb
        path: Output/pdb/*.zip
  build-x32:
    name: Build (Visual Studio, 32-bit)
    needs: pre_job
    runs-on: windows-latest
    env:
      build_number: ${{ needs.pre_job.outputs.build_number }}
      new_version: ${{ needs.pre_job.outputs.new_version }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Required due to the way Git works, without it this action won't be able to find any or the correct tags
    - name: Run Upversion
      id:   upversion
      shell: pwsh
      run: |
        .\tools\upversion\upversion.ps1
      env:
        MAJORVERSION: ${{ needs.pre_job.outputs.major }}
        MINORVERSION: ${{ needs.pre_job.outputs.minor }}
        PATCHVERSION: ${{ needs.pre_job.outputs.patch }}
    - name: Checkout submodules
      run: git submodule update --init --recursive
    - name: Turn on problem matcher
      uses: ammaraskar/msvc-problem-matcher@master
    - name: Run build-x32 powershell
      shell: pwsh
      run: |
        .\ci\win-release-x86.ps1
    - name: Install Python packages
      uses: insightsengineering/pip-action@v2
      with:
        packages: |
          b2sdk
    - name: Upload artifact to B2
      run: python .\ci\upload-b2.py .\Output\zip Win-x32
      env:
        B2_APP_KEY: ${{ secrets.B2_APP_KEY }}
        B2_BUCKET_ID: ${{ secrets.B2_BUCKET_ID }}
        B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
    - name: Archive x86 build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Odamex-Win-x86
        path: Output/zip/*.zip
    - name: Archive x86 pdb artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Odamex-Win-x86-pdb
        path: Output/pdb/*.zip
  package-and-upload:
    name: Package and Upload Artifacts
    runs-on: windows-latest
    needs: [pre_job, build, build-x32]
    env:
      build_number: ${{ needs.pre_job.outputs.build_number }}
      new_version: ${{ needs.pre_job.outputs.new_version }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-tags: true
    - name: Run Upversion
      id:   upversion
      shell: pwsh
      run: |
        .\tools\upversion\upversion.ps1
      env:
        MAJORVERSION: ${{ needs.pre_job.outputs.major }}
        MINORVERSION: ${{ needs.pre_job.outputs.minor }}
        PATCHVERSION: ${{ needs.pre_job.outputs.patch }}
    - name: Checkout submodules
      run: git submodule update --init --recursive
    - name: Download x86 artifacts
      uses: actions/download-artifact@v4
      with:
        name: Odamex-Win-x86
    - name: Download x64 artifacts
      uses: actions/download-artifact@v4
      with:
        name: Odamex-Win-x64
    - name: Install setup compiler
      shell: pwsh
      run: |
        if (-not (Get-Command iscc -ErrorAction SilentlyContinue)) {
          choco install innosetup -y --no-progress
        }
    - name: Stage and run setup compiler
      shell: pwsh
      run: |
        .\ci\stage-inno-setup-and-run.ps1
    - name: Upload setup installer to Github
      uses: actions/upload-artifact@v4
      with:
        name: Odamex-Installer
        path: 'Output/*.exe'
    - name: Download x86 pdb
      uses: actions/download-artifact@v4
      with:
        name: Odamex-Win-x86-pdb
    - name: Download x64 pdb
      uses: actions/download-artifact@v4
      with:
        name: Odamex-Win-x64-pdb
    - name: Create or update prerelease
      uses: ./.github/actions/update-prerelease
      env:
        build_number: ${{ needs.pre_job.outputs.build_number }}
        new_version: ${{ needs.pre_job.outputs.new_version }}
      with:
        build_number: ${{ env.build_number }}
        new_version: ${{ env.new_version }}
        files: |
          ./odamex-win*.zip
          ./odamex-debug-*.zip
          ./Output/*.exe
